{% extends 'troubleshooting/base.html' %}

{% block title %}FNFM Troubleshooting System - Analysis{% endblock %}

{% block content %}
<div class="header-section">
    <h1><i class="fas fa-cogs me-3"></i>FNFM Troubleshooting System</h1>
    <p class="mb-0">Advanced Knowledge Graph-based Failure Analysis</p>
</div>

<div class="form-section">
    <h3 class="mb-4"><i class="fas fa-search me-2"></i>Analysis Parameters</h3>
    <form id="troubleshootingForm">
        {% csrf_token %}
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="failure" class="form-label"><i class="fas fa-exclamation-triangle me-2"></i>Failure Type</label>
                <select class="form-select" id="failure" name="failure" required>
                    <option value="">Select a failure type...</option>
                    {% for failure in failures %}
                        <option value="{{ failure }}">{{ failure }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="serial_number" class="form-label"><i class="fas fa-barcode me-2"></i>Serial Number</label>
                <select class="form-select" id="serial_number" name="serial_number" required>
                    <option value="">Select serial number...</option>
                    {% for serial in serial_numbers %}
                        <option value="{{ serial }}">{{ serial }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="job_number" class="form-label"><i class="fas fa-clipboard-list me-2"></i>Job Number</label>
                <select class="form-select" id="job_number" name="job_number" required disabled>
                    <option value="">Select job number...</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="start_job" class="form-label"><i class="fas fa-play me-2"></i>Start Job</label>
                <select class="form-select" id="start_job" name="start_job" required disabled>
                    <option value="">Select start job...</option>
                </select>
            </div>
        </div>

        <div class="text-center">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-analytics me-2"></i>Analyze Failure
            </button>
        </div>
    </form>
</div>

<div class="loading-spinner" id="loadingSpinner">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">Analyzing failure patterns...</p>
</div>

<div class="results-section" id="resultsSection">
    <h3 class="mb-4"><i class="fas fa-chart-line me-2"></i>Analysis Results</h3>
    
    <div id="alertsContainer"></div>
    
    <div id="partitionInfo" class="alert alert-info" style="display: none;">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Partition ID:</strong> <span id="partitionIdValue"></span>
    </div>

    <div id="graphDataContainer" style="display: none;">
        <h4 class="mb-3"><i class="fas fa-project-diagram me-2"></i>Knowledge Graph Data</h4>
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="graphDataTable">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Predicate</th>
                        <th>Object</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="errorContainer"></div>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    // Handle serial number change
    $('#serial_number').change(function() {
        const serialNumber = $(this).val();
        if (serialNumber) {
            $.ajax({
                url: '{% url "troubleshooting:get_job_numbers" %}',
                method: 'POST',
                data: JSON.stringify({serial_number: serialNumber}),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(data) {
                    $('#job_number').empty().append('<option value="">Select job number...</option>');
                    data.job_numbers.forEach(function(job) {
                        $('#job_number').append(`<option value="${job}">${job}</option>`);
                    });
                    $('#job_number').prop('disabled', false);
                    $('#start_job').empty().append('<option value="">Select start job...</option>').prop('disabled', true);
                },
                error: function(xhr) {
                    showError('Error loading job numbers: ' + xhr.responseJSON.error);
                }
            });
        } else {
            $('#job_number').empty().append('<option value="">Select job number...</option>').prop('disabled', true);
            $('#start_job').empty().append('<option value="">Select start job...</option>').prop('disabled', true);
        }
    });

    // Handle job number change
    $('#job_number').change(function() {
        const serialNumber = $('#serial_number').val();
        const jobNumber = $(this).val();
        if (serialNumber && jobNumber) {
            $.ajax({
                url: '{% url "troubleshooting:get_start_jobs" %}',
                method: 'POST',
                data: JSON.stringify({
                    serial_number: serialNumber,
                    job_number: jobNumber
                }),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(data) {
                    $('#start_job').empty().append('<option value="">Select start job...</option>');
                    data.start_jobs.forEach(function(job) {
                        $('#start_job').append(`<option value="${job}">${job}</option>`);
                    });
                    $('#start_job').prop('disabled', false);
                },
                error: function(xhr) {
                    showError('Error loading start jobs: ' + xhr.responseJSON.error);
                }
            });
        } else {
            $('#start_job').empty().append('<option value="">Select start job...</option>').prop('disabled', true);
        }
    });

    // Handle form submission
    $('#troubleshootingForm').submit(function(e) {
        e.preventDefault();
        
        const formData = {
            failure: $('#failure').val(),
            serial_number: $('#serial_number').val(),
            job_number: $('#job_number').val(),
            start_job: $('#start_job').val()
        };

        // Show loading spinner
        $('#loadingSpinner').show();
        $('#resultsSection').hide();
        $('#errorContainer').empty();

        $.ajax({
            url: '{% url "troubleshooting:analyze_failure" %}',
            method: 'POST',
            data: JSON.stringify(formData),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(data) {
                $('#loadingSpinner').hide();
                displayResults(data);
            },
            error: function(xhr) {
                $('#loadingSpinner').hide();
                showError('Analysis failed: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
            }
        });
    });

    function displayResults(data) {
        // Show partition ID
        $('#partitionIdValue').text(data.partition_id);
        $('#partitionInfo').show();

        // Display alerts
        const alertsContainer = $('#alertsContainer');
        alertsContainer.empty();
        
        if (data.alerts && data.alerts.length > 0) {
            const alertHtml = `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Root Cause Analysis</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-borderless text-white">
                            <thead>
                                <tr>
                                    <th>Root Cause</th>
                                    <th>Trigger</th>
                                    <th>Data Channel</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.alerts.map(alert => `
                                    <tr>
                                        <td>${alert[0]}</td>
                                        <td>${alert[1]}</td>
                                        <td>${alert[2]}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            alertsContainer.html(alertHtml);
        } else {
            alertsContainer.html(`
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Analysis Complete</h5>
                    <p class="mb-0">No critical issues detected for the specified failure type.</p>
                </div>
            `);
        }

        // Display graph data
        if (data.graph_data && data.graph_data.length > 0) {
            const tbody = $('#graphDataTable tbody');
            tbody.empty();
            data.graph_data.forEach(function(row) {
                const statusBadge = row.Status === true ? 
                    '<span class="badge bg-danger">Failed</span>' : 
                    row.Status === false ? 
                    '<span class="badge bg-success">Passed</span>' : 
                    '<span class="badge bg-secondary">N/A</span>';
                
                tbody.append(`
                    <tr>
                        <td>${row.Subject}</td>
                        <td>${row.Predicate}</td>
                        <td>${row.Object}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `);
            });
            $('#graphDataContainer').show();
        }

        $('#resultsSection').show();
    }

    function showError(message) {
        $('#errorContainer').html(`
            <div class="alert alert-danger alert-dismissible fade show">
                <i class="fas fa-exclamation-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
    }
});
</script>
{% endblock %}
